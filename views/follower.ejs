<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chillinker follower list</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/following.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+KR:wght@100;200;300;400;500;600;700&family=Sriracha&display=swap');
      </style>
      <script
        src="https://kit.fontawesome.com/0b832ce4c1.js"
        crossorigin="anonymous"
      ></script>
</head>
<body>
    <div class="wrap">
      <%- include('header.ejs') %>
        <main>
          <div class="inner">
            <div class="following_title">
                <span>팔로워</span>            
            </div>
            <ul class="following_list">
              <% followerList.forEach(function(follower) { %>
                <li>
                    <a class="profile_link" href="#">
                        <img src="/profile_sample.png" alt="profile image">
                        <span class="name"><%= follower.followers_nickname %></span>
                        <span class="intro"><%= follower.followers_email %></span><!-- 여기는 추후에 인트로로 수정 알아보기 -->
                    </a>
                    <% if (follower.isFollowing) { %>
                      <a class="unfollowing_btn" href="#">언팔로우</a>
                  <% } else { %>
                      <a class="unfollowing_btn" href="#">팔로잉</a>
                  <% } %>
                </li>
                <% }); %>
            </ul>
          </div>
        </main>
        <%- include('footer.ejs') %>
      </div>
      <script>
        let page = 1; // 초기 페이지 번호
        let isLoading = false; // 데이터를 로드 중인지 여부를 나타내는 변수
    
        // 스크롤 이벤트 감지
        window.addEventListener('scroll', () => {
            // 문서의 높이와 스크롤 위치를 이용하여 페이지 하단 도달 여부 확인
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight) {
                loadMoreData();
            }
        });
    
        // 추가 데이터를 로드하는 함수
        function loadMoreData() {
            // 데이터를 이미 로드 중인 경우 더 이상의 요청을 방지하기 위해 isLoading 변수를 확인
            if (!isLoading) {
                isLoading = true; // 데이터 로딩 시작
    
                // 서버로 요청을 보내는 fetch 함수를 이용하여 데이터를 가져옴
                fetch(`/api/followers?page=${page}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        appendData(data); // 받은 데이터를 추가
                        page++; // 페이지 번호 증가
                        isLoading = false; // 데이터 로딩 종료
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                        isLoading = false; // 데이터 로딩 종료
                    });
            }
        }
    
        // 받은 데이터를 화면에 추가하는 함수
        function appendData(data) {
            const list = document.querySelector('.following_list');
            data.forEach(follower => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <a class="profile_link" href="#">
                        <img src="/profile_sample.png" alt="profile image">
                        <span class="name">${follower.followers_nickname}</span>
                        <span class="intro">${follower.followers_email}</span>
                    </a>
                    ${follower.isFollowing ? '<a class="unfollowing_btn" href="#">언팔로우</a>' : '<a class="unfollowing_btn" href="#">팔로잉</a>'}
                `;
                list.appendChild(li);
            });
        }
    </script>
    </body>
</html>